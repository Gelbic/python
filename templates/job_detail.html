{% extends "layout.html" %}
{% block title %}{{ job.job_name }}{% endblock %}
{% block content %}
<div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
        <h1 class="text-4xl font-bold text-gray-900">{{ job.job_name }}</h1>
        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mt-4 md:mt-0">
            <a href="{{ url_for('edit_job', job_id=job.id) }}" class="bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600">Upravit</a>
            <form action="{{ url_for('delete_job', job_id=job.id) }}" method="post" onsubmit="return confirm('Opravdu chcete tuto zakázku smazat? Všechny úkoly budou smazány.');">
                <button type="submit" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Smazat</button>
            </form>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">Detaily zakázky</h2>
            <p><strong class="font-medium">Číslo:</strong> {{ job.job_number }}</p>
            <p><strong class="font-medium">Stav:</strong> {{ job.status }}</p>
            <p><strong class="font-medium">Termín:</strong> {{ job.due_date }}</p>
            <p><strong class="font-medium">Cena:</strong> {{ "%.2f Kč" | format(job.price) if job.price else "Neuvedeno" }}</p>
            <p><strong class="font-medium">Hodinová sazba:</strong> {{ "%.2f Kč" | format(job.hourly_rate) if job.hourly_rate else "Neuvedeno" }}</p>
            <p><strong class="font-medium">Stav platby:</strong> {{ job.payment_status }}</p>
            <p class="mt-4"><strong class="font-medium">Popis:</strong></p>
            <p class="mt-1 text-gray-600">{{ job.description }}</p>
            {% if job.status == 'Dokončená' and job.payment_status == 'Nezaplaceno' %}
                <div class="mt-4">
                    <button id="generate-invoice-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Vygenerovat fakturu</button>
                </div>
            {% endif %}
        </div>
        <div>
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">Zákazník</h2>
            <p><strong class="font-medium">Jméno:</strong> {{ job.customer_name }}</p>
            <p><strong class="font-medium">Firma:</strong> {{ job.company }}</p>
            <p><strong class="font-medium">Adresa:</strong> {{ job.address }}</p>
            <p><strong class="font-medium">Telefon:</strong> {{ job.phone }}</p>
            <p><strong class="font-medium">E-mail:</strong> {{ job.email }}</p>
        </div>
    </div>
</div>

<div class="bg-white p-6 rounded-lg shadow-md mt-8">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Úkoly</h2>
    <form id="task-form" class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4">
        <input type="hidden" name="job_id" value="{{ job.id }}">
        <input type="text" name="task_name" placeholder="Název úkolu" required class="flex-1 rounded-md border-gray-300 shadow-sm">
        <input type="text" name="notes" placeholder="Poznámky" class="flex-1 rounded-md border-gray-300 shadow-sm">
        <input type="date" name="due_date" class="rounded-md border-gray-300 shadow-sm">
        <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Přidat úkol</button>
    </form>
    <ul id="task-list" class="divide-y divide-gray-200">
        {% for task in tasks %}
        <li class="py-4 flex justify-between items-center" data-task-id="{{ task.id }}">
            <div>
                <input type="checkbox" {% if task.is_completed %}checked{% endif %} class="toggle-task-status mr-2">
                <span class="text-lg {% if task.is_completed %}line-through text-gray-500{% endif %}">{{ task.task_name }}</span>
                {% if task.notes %}
                    <span class="ml-2 text-sm text-gray-500">({{ task.notes }})</span>
                {% endif %}
            </div>
            <span class="text-sm text-gray-400">{{ task.due_date }}</span>
        </li>
        {% else %}
        <li class="py-4 text-center text-gray-500">Zatím nebyly přidány žádné úkoly.</li>
        {% endfor %}
    </ul>
</div>

<div class="bg-white p-6 rounded-lg shadow-md mt-8">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Odpracované hodiny (Celkem: {{ "%.2f" | format(total_hours) }}h)</h2>
    <form action="{{ url_for('add_hours', job_id=job.id) }}" method="post" class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4">
        <input type="date" name="date_spent" required class="rounded-md border-gray-300 shadow-sm">
        <input type="number" step="0.1" name="hours" placeholder="Počet hodin" required class="w-full md:w-28 rounded-md border-gray-300 shadow-sm">
        <select name="worker_id" class="rounded-md border-gray-300 shadow-sm">
            <option value="">-- Vyber pracovníka --</option>
            {% for worker in workers %}
                <option value="{{ worker.id }}">{{ worker.name }}</option>
            {% endfor %}
        </select>
        <input type="text" name="description" placeholder="Popis práce (volitelné)" class="flex-1 rounded-md border-gray-300 shadow-sm">
        <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Přidat</button>
    </form>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Datum</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pracovník</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hodin</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Popis</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for hour in hours %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">{{ hour.date_spent }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ hour.worker_name if hour.worker_name else 'Neuvedeno' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ "%.2f" | format(hour.hours) }}</td>
                    <td class="px-6 py-4">{{ hour.description }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">Žádné odpracované hodiny.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="bg-white p-6 rounded-lg shadow-md mt-8">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Další služby</h2>
    <form action="{{ url_for('add_service', job_id=job.id) }}" method="post" class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4">
        <input type="text" name="service_name" placeholder="Název služby" required class="flex-1 rounded-md border-gray-300 shadow-sm">
        <input type="number" step="0.01" name="cost" placeholder="Částka (Kč)" required class="w-full md:w-32 rounded-md border-gray-300 shadow-sm">
        <input type="text" name="notes" placeholder="Poznámky (volitelné)" class="flex-1 rounded-md border-gray-300 shadow-sm">
        <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Přidat</button>
    </form>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Služba</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Částka (Kč)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Poznámky</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for service in additional_services %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">{{ service.service_name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ "%.2f" | format(service.cost) }}</td>
                    <td class="px-6 py-4">{{ service.notes }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="3" class="px-6 py-4 text-center text-gray-500">Žádné další služby.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="invoice-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Generovat fakturu</h3>
            <form action="{{ url_for('create_invoice', job_id=job.id) }}" method="post">
                <div class="mb-4">
                    <label for="invoice_number" class="block text-gray-700">Číslo faktury</label>
                    <input type="text" id="invoice_number" name="invoice_number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div class="mb-4">
                    <label for="payment_type" class="block text-gray-700">Způsob úhrady</label>
                    <select id="payment_type" name="payment_type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="příkazem">Bankovním převodem</option>
                        <option value="hotově">Hotově</option>
                    </select>
                </div>
                <div class="items-center px-4 py-3">
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                        Generovat a uložit
                    </button>
                    <button id="close-modal-btn" type="button" class="mt-3 w-full px-4 py-2 bg-white text-base font-medium text-gray-700 rounded-md border border-gray-300 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        Zrušit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    // Skript pro zobrazení/skrytí modálního okna
    document.getElementById('generate-invoice-btn').addEventListener('click', () => {
        document.getElementById('invoice-modal').classList.remove('hidden');
    });
    document.getElementById('close-modal-btn').addEventListener('click', () => {
        document.getElementById('invoice-modal').classList.add('hidden');
    });

    // Skript pro odeslání formuláře pro úkoly (AJAX)
    document.getElementById('task-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        const response = await fetch('/tasks/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(data)
        });
        const result = await response.json();
        
        if (result.success) {
            window.location.reload();
        } else {
            alert('Chyba při přidávání úkolu.');
        }
    });

    // Skript pro přepínání stavu úkolů (AJAX)
    document.getElementById('task-list').addEventListener('change', async (e) => {
        if (e.target.classList.contains('toggle-task-status')) {
            const taskId = e.target.closest('li').dataset.taskId;
            
            const response = await fetch(`/tasks/${taskId}/toggle`, {
                method: 'POST'
            });
            const result = await response.json();
            
            if (result.success) {
                const textSpan = e.target.closest('li').querySelector('span');
                if (result.new_status === 1) {
                    textSpan.classList.add('line-through', 'text-gray-500');
                } else {
                    textSpan.classList.remove('line-through', 'text-gray-500');
                }
            } else {
                alert('Chyba při změně stavu úkolu.');
                e.target.checked = !e.target.checked; // Vrátí checkbox do původního stavu
            }
        }
    });
</script>
{% endblock %}